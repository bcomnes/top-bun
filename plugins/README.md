# fastify-domstack

A Fastify plugin for integrating DomStack static site generation with Fastify dynamic server routes.

## Installation

```bash
npm install @domstack/fastify-domstack
```

## Features

- üöÄ Build DomStack sites at server startup
- üìù Serve static files generated by DomStack
- üîÑ Watch mode for automatic rebuilding during development
- ‚ö° Server-side routes using `server.js` files that integrate with DomStack layouts

## Usage

```js
import Fastify from 'fastify'
import fastifyDomstack from '@domstack/fastify-domstack'

const fastify = Fastify({
  logger: true
})

// Register the plugin
await fastify.register(fastifyDomstack, {
  src: './src',                      // Source directory for DomStack site
  dest: './dist',                    // Destination directory for built assets
  watch: process.env.NODE_ENV !== 'production',  // Enable watch mode in development
  domstackOpts: {                    // Options to pass to DomStack
    buildDrafts: process.env.NODE_ENV !== 'production'
  }
})

// Start the server
await fastify.listen({ port: 3000 })
```

## Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `src` | `string` | (required) | Source directory for DomStack site |
| `dest` | `string` | `.fastify-domstack` | Destination directory for built assets |
| `domstackOpts` | `object` | `{}` | Options to pass to DomStack |
| `prefix` | `string` | `/` | URL prefix for all routes |
| `static` | `boolean` | `true` | Enable serving static files |
| `watch` | `boolean` | `false` | Enable watch mode |
| `enableServerRoutes` | `boolean` | `true` | Enable server-side routes from server.js pages |

## Server Routes

In addition to regular DomStack pages that are built at build time, you can create dynamic server routes using `server.js` files:

```js
// src/api/server.js

export const vars = {
  title: 'API Example',
  layout: 'root' // Use the root layout
}

// Optional: specify HTTP method, defaults to GET
export const method = 'GET'

export default async function apiRoute(request, reply) {
  // For HTML responses, return a string
  return `
    <h1>API Example</h1>
    <p>The server time is: ${new Date().toLocaleString()}</p>
  `;
  
  // For JSON responses, return an object
  // return { message: 'This is a server-side route' };
  
  // Or use reply directly
  // reply.code(200).send({ message: 'This is a server-side route' });
}
```

Server routes have these benefits:
- They're processed for each request, not at build time
- They receive the Fastify request and reply objects
- They can be wrapped in DomStack layouts or return raw data (JSON, HTML, etc.)
- They can use the full Fastify ecosystem (hooks, decorators, etc.)

## Access to DomStack Instance

The plugin decorates the Fastify instance with a `domstack` property:

```js
fastify.get('/rebuild', async (request, reply) => {
  await fastify.domstack.build()
  return { success: true }
})
```

## License

MIT